---
title: "Untitled"
format: pdf
editor: visual
editor_options: 
  chunk_output_type: console
---

## Research Question 

What drives the efficiency of schools in the Visegrad countries in terms of standardized test performance?

## Approach 

Use nonparametric enevelopment techniques to estimate a production(education) frontier for each Visegrad country, and for the region as a whole.

## Data 

Data is collected from the 2018 PISA survey, it contains information on schools(and their environment), teachers, and students(and parental engagement).

### Summary statistics of the data 

```{r echo=FALSE, warning=FALSE, message=FALSE}

library(tidyverse)

data <- read_csv("../../modeling/analysis_data.csv") %>%
  # read_csv(file = "modeling/analysis_data.csv") %>%
  select(- ends_with("cog"), - starts_with("med"))
 
```

-   Sample of schools in the analysis per country:

    Our sample is constituted of 623 schools decomposed per the table below

```{r, echo=F, warning=FALSE, message=FALSE}
data %>% 
  group_by(CNT) %>% 
  count() %>% 
  kableExtra::kable(format = "latex", booktab = T) 

```

The variables we initially decided to use are the following:

-   Students:

    -   `total_sudents`

    -   gender characteristics : `students_male (number of),``students_female (number of)`

    -   Parents: `ap_parental_eng` (proportion of parents who engage with the school staff regarding their children education)

-   Schools:

    -   School charactaristcs: `ratio_f2m (ratio of female to male students), ratio_pt2ft (part time to full time tachers), ratio_t2s (students per teacher), dropout_rate, funding (percentage of government funding)`

-   Teachers:

    -   `teachers_ft`(number of full timer teachers), `teachers_pt` (number of full timer teachers)

    -   `total_teachers` : Totoal number of teachers

-   Context:

    -   Location `bol_locataion` : 1- school is in Urban area, 0- School is in Rural area

    -   Extra activities : `bol_extra_acts` : 1- Yes there are official extra activities in the curricilum, 0- No

    -   `bol_competition` : 1- There's at least another school in the area, 0- There's no other schools in the area

    -   `bol_career_guidance` : 1- There's an official career guidance curriculum in the school, 0- There's not

Mean and standard deviation tables for each variable per country is depicted as follows:

```{r, echo = F, warning=FALSE, message=FALSE}
data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  summarise(
    across(
      everything(),
      mean,
      na.rm = T
    )
  ) %>% 
  pivot_longer(
    2:ncol(.)
  ) %>% 
  pivot_wider(names_from = CNT) %>% 
  kableExtra::kable(
    booktab = T, 
    caption = "Table of means", 
    digits = 3
  )


data %>%
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  summarise(
    across(
      everything(),
      sd,
      na.rm = T
    )
  ) %>% 
  pivot_longer(
    2:ncol(.)
  ) %>% 
  pivot_wider(names_from = CNT) %>% 
  kableExtra::kable(
    booktab = T, 
    caption = "Table of standard deviation",
    digits = 3
  )
```

### Visualisations

```{r, echo = F, warning=FALSE, message=FALSE}

data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  mutate(
    bol_location = as.character(bol_location)
  ) %>% 
  ggplot()+
  geom_boxplot(
    aes(
      x = value,
      y = bol_location,
      fill = avg
    )
  )+
  facet_grid(CNT~avg)+
  labs(
    title = "Average grad in the three subjects\n controlled by location",
    x = "Average grade",
    y = "Location"
  )
  
```

```{r, echo = F, warning=FALSE, message=FALSE}
data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 

  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  mutate(
    bol_competition = as.character(bol_competition),
    value = log(value)
  ) %>% 
  ggplot()+
  geom_boxplot(
    aes(
      x = value,
      y = bol_competition,
      fill = avg
    )
  )+
  facet_grid(CNT~avg) +
  labs(
    title = "Average grades and Competition of school area",
    subtitle = "Controlled by subject",
    x = "Average grade",
    y = "Competion"
  )
```

```{r, echo = F, warning=FALSE, message=FALSE}
data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 

  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  mutate(
    bol_career_guidance = as.character(bol_career_guidance)
  ) %>% 
  ggplot()+
  geom_boxplot(
    aes(
      x = value,
      y = bol_career_guidance,
      fill = avg
    )
  )+
  facet_grid(CNT~avg)+
  labs(
    title = "Average grades and Career guidance",
    x = 'Average Grade',
    y = 'Formal Guidance'
  )
```

```{r, echo = F, warning=FALSE, message=FALSE}
data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  ggplot()+
  geom_point(
    aes(
      x = value,
      y = ratio_s2t,
      color = avg
    ),
    size = 0.1,
    alpha = 0.7
  )+
  facet_grid(CNT~avg)+
  labs(
    title = 'Averge Grades by the Students to Teacher Ratio',
    x = "Average Grades",
    y = "Students to Teacher Ratio"
  )
```

```{r, echo = F, warning=FALSE, message=FALSE}
data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  ggplot()+
  geom_point(
    aes(
      x = value,
      y = total_students,
      color = avg
    ),
    size = 0.1,
    alpha = 0.7
  )+
  facet_grid(CNT~avg) +
  labs(
    title = 'Total Number of Students and Average grades',
    x = 'Average Grade',
    y = 'Total Number of Students '
  )
```

```{r,echo = F, warning=FALSE, message=FALSE}

data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  pivot_longer(
    c(teachers_ft,teachers_pt),
    names_to = "teachers",
    values_to = 'teachers_num'
  ) %>% 
  ggplot()+
  geom_point(
    aes(
      x = total_students,
      y = teachers_num,
      color = teachers
    ),
    size = 0.2,
    alpha = 0.7
  ) +
  facet_grid(CNT~.) +
  labs(
    title = "Total Number of Students and Total Number of Teachers",
    subtitle = "Controlled by Part time and Full time employment types", 
    x = "Total Number of Students",
    y = "Total Number of Teachers"
  )

```

```{r,echo = F, warning=FALSE, message=FALSE}

data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  # pivot_longer(
  #   c(teachers_ft,teachers_pt),
  #   names_to = "teachers",
  #   values_to = 'teachers_num'
  # ) %>% 
  ggplot()+
  geom_point(
    aes(
      x = value,
      y = dropout_rate,
      color = avg
    ),
    size = 0.2,
    alpha = 0.7
  ) +
  facet_grid(CNT~avg, scales = "free") +
  labs(
    title = "Average Grades and Dropout Rates",
    x = "Average Grades",
    y = "Dropout Rates"
  )

```

```{r,echo = F, warning=FALSE, message=FALSE}

data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  pivot_longer(
    c(ratio_s2t,total_students, ratio_f2m),
    names_to = "students_ratios",
    values_to = 'sr_vals'
  ) %>%
  ggplot()+
  geom_point(
    aes(
      y = dropout_rate,
      x = sr_vals,
      color = students_ratios
    ),
    size = 0.2,
    alpha = 0.7
  ) +
  facet_grid(CNT~students_ratios, scales = "free") +
  labs(
    title = "Dropout Rates and school/student characteristics",
    x = "Dropout Rates",
    y = ""
  )

```

```{r,echo = F, warning=FALSE, message=FALSE}

data %>% 
  select(-CNTSCHID, -1) %>% 
  group_by(CNT) %>% 
  pivot_longer(
    starts_with("avg"), 
    names_to = 'avg'
  ) %>% 
  # pivot_longer(
  #   c(teachers_ft,teachers_pt),
  #   names_to = "teachers",
  #   values_to = 'teachers_num'
  # ) %>% 
  ggplot()+
  geom_point(
    aes(
      x = value,
      y = ratio_s2t,
      color = avg
    ),
    size = 0.2,
    alpha = 0.7
  ) +
  facet_grid(CNT~avg, scales = "free") +
  labs(
    title = "Average Grades and Students to teachers Ratio",
    x = "Average Grades",
    y = "Students to teachers Ratio"
  )

```
